<view class="container">
  <view wx:if="{{loading}}" class="loading">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <view wx:else class="form">
    <!-- å®¢æˆ·é€‰æ‹© -->
    <view class="form-item">
      <text class="form-label">é€‰æ‹©å®¢æˆ· *</text>
      <view class="search-picker-container">
        <view class="search-input-wrapper">
          <input 
            class="search-input" 
            placeholder="æœç´¢å®¢æˆ·..." 
            value="{{customerSearchKey}}" 
            bindinput="onCustomerSearchInput" 
          />
        </view>
        <view 
          class="selected-item" 
          wx:if="{{selectedCustomer}}"
        >
          <text class="selected-text">{{selectedCustomer.name}}</text>
          <text class="clear-btn" bindtap="clearSelectedCustomer">Ã—</text>
        </view>
        <view 
          class="selected-item placeholder" 
          wx:else
          bindtap="toggleCustomerList"
        >
          <text>è¯·é€‰æ‹©å®¢æˆ·</text>
        </view>
        
        <view class="search-results" wx:if="{{showCustomerList}}">
          <scroll-view scroll-y="true" style="max-height: 400rpx;">
            <view 
              class="result-item" 
              wx:for="{{filteredCustomers}}" 
              wx:key="id"
              bindtap="selectCustomer"
              data-customer="{{item}}"
            >
              <text class="result-name">{{item.name}}</text>
              <text class="result-contact">{{item.contact}} - {{item.phone}}</text>
            </view>
            <view class="result-item empty" wx:if="{{filteredCustomers.length === 0}}">
              <text>æš‚æ— å®¢æˆ·</text>
            </view>
          </scroll-view>
        </view>
      </view>
    </view>

    <!-- å•†å“é€‰æ‹© -->
    <view class="form-item">
      <text class="form-label">é€‰æ‹©å•†å“ *</text>
      <view class="search-picker-container">
        <view class="search-input-wrapper">
          <input 
            class="search-input" 
            placeholder="æœç´¢å•†å“..." 
            value="{{productSearchKey}}" 
            bindinput="onProductSearchInput" 
          />
          <view class="refresh-btn" bindtap="refreshProducts">
            <text class="refresh-icon">ğŸ”„</text>
          </view>
        </view>
        <view 
          class="selected-item placeholder" 
          bindtap="toggleProductList"
        >
          <text>ç‚¹å‡»é€‰æ‹©å•†å“</text>
        </view>
        
        <view class="search-results" wx:if="{{showProductList}}">
          <scroll-view scroll-y="true" style="max-height: 400rpx;">
            <view 
              class="result-item" 
              wx:for="{{filteredProducts}}" 
              wx:key="id"
              bindtap="selectProduct"
              data-product="{{item}}"
            >
              <text class="result-name">{{item.name}}</text>
              <text class="result-code">ç¼–ç : {{item.code}} | åº“å­˜: {{item.stock}}æ–¤</text>
            </view>
            <view class="result-item empty" wx:if="{{filteredProducts.length === 0}}">
              <text>æš‚æ— å•†å“</text>
              <view class="quick-add-btn" bindtap="quickAddProduct">
                <text class="quick-add-text">+ å¿«é€Ÿæ·»åŠ å•†å“</text>
              </view>
            </view>
          </scroll-view>
        </view>
      </view>
    </view>

    <!-- å·²é€‰å•†å“åˆ—è¡¨ -->
    <view class="form-item" wx:if="{{selectedProducts.length > 0}}">
      <text class="form-label">å·²é€‰å•†å“ ({{selectedProducts.length}})</text>
      <view class="selected-products">
        <view 
          class="selected-product-item" 
          wx:for="{{selectedProducts}}" 
          wx:key="id"
        >
          <!-- å•†å“ä¿¡æ¯ -->
          <view class="product-header">
            <view class="product-info">
              <text class="product-name">{{item.name}}</text>
              <text class="product-code">{{item.code}}</text>
            </view>
            <view class="product-subtotal">
              <text class="subtotal-price">Â¥{{item.subtotal}}</text>
              <text class="remove-btn" bindtap="removeProduct" data-index="{{index}}">åˆ é™¤</text>
            </view>
          </view>
          
          <!-- æ“ä½œåŒºåŸŸ -->
          <view class="product-actions">
            <!-- å•ä½é€‰æ‹© -->
            <view class="unit-price-row">
              <view class="unit-picker" wx:if="{{item.units.length > 1}}">
                <picker 
                  mode="selector" 
                  range="{{item.units}}" 
                  range-key="unitName"
                  value="{{item.unitsIndex || 0}}"
                  bindchange="onUnitChange"
                  data-index="{{index}}"
                >
                  <view class="picker">
                    {{item.selectedUnit.unitName}} â–¾
                  </view>
                </picker>
              </view>
              <text wx:else class="unit-text">{{item.selectedUnit.unitName}}</text>
              
              <view class="price-input-wrapper">
                <text class="price-symbol">Â¥</text>
                <input 
                  class="price-input" 
                  type="digit" 
                  placeholder="0.00"
                  value="{{item.inputPrice !== null && item.inputPrice !== '' && item.inputPrice !== undefined && item.inputPrice !== '__EMPTY__' ? item.inputPrice : (item.inputPrice === '__EMPTY__' ? '' : item.selectedUnit.price || 0)}}"
                  bindinput="onPriceInput" 
                  bindblur="onPriceBlur"
                  data-index="{{index}}"
                />
                <text wx:if="{{item.isHistoryPrice}}" class="history-tag">å†å²</text>
              </view>
            </view>
            
            <!-- æ•°é‡æ“ä½œ -->
            <view class="quantity-row">
              <text class="quantity-label">æ•°é‡</text>
              <view class="quantity-controls">
                <text class="quantity-btn minus" bindtap="decreaseQuantity" data-index="{{index}}">-</text>
                <input 
                  class="quantity-input" 
                  type="digit" 
                  value="{{item.quantity}}" 
                  bindinput="onQuantityChange" 
                  data-index="{{index}}"
                />
                <text class="quantity-btn plus" bindtap="increaseQuantity" data-index="{{index}}">+</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ€»é‡‘é¢ -->
    <view class="form-item" wx:if="{{selectedProducts.length > 0}}">
      <text class="form-label">æ€»é‡‘é¢</text>
      <view class="total-amount red-amount">
        <text class="amount-value">Â¥{{totalAmount}}</text>
      </view>
    </view>

    <!-- å¤‡æ³¨ -->
    <view class="form-item">
      <text class="form-label">å¤‡æ³¨</text>
      <textarea 
        class="form-textarea" 
        placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯" 
        value="{{remark}}" 
        bindinput="onRemarkChange"
      ></textarea>
    </view>

    <view class="btn-group">
      <button class="save-btn" bindtap="saveDraft" disabled="{{submitLoading}}">
        {{submitLoading ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜è‰ç¨¿'}}
      </button>
      <button class="submit-btn" bindtap="submit" disabled="{{submitLoading}}">
        {{submitLoading ? 'æäº¤ä¸­...' : 'ç”Ÿæˆé”€å”®å•'}}
      </button>
    </view>
  </view>
</view>