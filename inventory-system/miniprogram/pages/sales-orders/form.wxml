<view class="container">
  <view wx:if="{{loading}}" class="loading">
    <text>加载中...</text>
  </view>

  <view wx:else class="form">
    <!-- 客户选择 -->
    <view class="form-item">
      <text class="form-label">选择客户 *</text>
      <view class="search-picker-container">
        <view class="search-input-wrapper">
          <input 
            class="search-input" 
            placeholder="搜索客户..." 
            value="{{customerSearchKey}}" 
            bindinput="onCustomerSearchInput" 
          />
        </view>
        <view 
          class="selected-item" 
          wx:if="{{selectedCustomer}}"
        >
          <text class="selected-text">{{selectedCustomer.name}}</text>
          <text class="clear-btn" bindtap="clearSelectedCustomer">×</text>
        </view>
        <view 
          class="selected-item placeholder" 
          wx:else
          bindtap="toggleCustomerList"
        >
          <text>请选择客户</text>
        </view>
        
        <view class="search-results" wx:if="{{showCustomerList}}">
          <scroll-view scroll-y="true" style="max-height: 400rpx;">
            <view 
              class="result-item" 
              wx:for="{{filteredCustomers}}" 
              wx:key="id"
              bindtap="selectCustomer"
              data-customer="{{item}}"
            >
              <text class="result-name">{{item.name}}</text>
              <text class="result-contact">{{item.contact}} - {{item.phone}}</text>
            </view>
            <view class="result-item empty" wx:if="{{filteredCustomers.length === 0}}">
              <text>暂无客户</text>
            </view>
          </scroll-view>
        </view>
      </view>
    </view>

    <!-- 商品选择 -->
    <view class="form-item">
      <text class="form-label">选择商品 *</text>
      <view class="search-picker-container">
        <view class="search-input-wrapper">
          <input 
            class="search-input" 
            placeholder="搜索商品..." 
            value="{{productSearchKey}}" 
            bindinput="onProductSearchInput" 
          />
        </view>
        <view 
          class="selected-item placeholder" 
          bindtap="toggleProductList"
        >
          <text>点击选择商品</text>
        </view>
        
        <view class="search-results" wx:if="{{showProductList}}">
          <scroll-view scroll-y="true" style="max-height: 400rpx;">
            <view 
              class="result-item" 
              wx:for="{{filteredProducts}}" 
              wx:key="id"
              bindtap="selectProduct"
              data-product="{{item}}"
            >
              <text class="result-name">{{item.name}}</text>
              <text class="result-code">编码: {{item.code}} | 库存: {{item.stock}}斤</text>
            </view>
            <view class="result-item empty" wx:if="{{filteredProducts.length === 0}}">
              <text>暂无商品</text>
            </view>
          </scroll-view>
        </view>
      </view>
    </view>

    <!-- 已选商品列表 -->
    <view class="form-item" wx:if="{{selectedProducts.length > 0}}">
      <text class="form-label">已选商品 ({{selectedProducts.length}})</text>
      <view class="selected-products">
        <view 
          class="selected-product-item" 
          wx:for="{{selectedProducts}}" 
          wx:key="id"
        >
          <!-- 商品信息 -->
          <view class="product-header">
            <view class="product-info">
              <text class="product-name">{{item.name}}</text>
              <text class="product-code">{{item.code}}</text>
            </view>
            <view class="product-subtotal">
              <text class="subtotal-price">¥{{item.subtotal}}</text>
              <text class="remove-btn" bindtap="removeProduct" data-index="{{index}}">删除</text>
            </view>
          </view>
          
          <!-- 操作区域 -->
          <view class="product-actions">
            <!-- 单位选择 -->
            <view class="unit-price-row">
              <view class="unit-picker" wx:if="{{item.units.length > 1}}">
                <picker 
                  mode="selector" 
                  range="{{item.units}}" 
                  range-key="unitName"
                  value="{{item.unitsIndex || 0}}"
                  bindchange="onUnitChange"
                  data-index="{{index}}"
                >
                  <view class="picker">
                    {{item.selectedUnit.unitName}} ▾
                  </view>
                </picker>
              </view>
              <text wx:else class="unit-text">{{item.selectedUnit.unitName}}</text>
              
              <view class="price-input-wrapper">
                <text class="price-symbol">¥</text>
                <input 
                  class="price-input" 
                  type="digit" 
                  placeholder="0.00"
                  value="{{item.inputPrice || item.selectedUnit.price}}"
                  bindinput="onPriceInput" 
                  bindblur="onPriceBlur"
                  data-index="{{index}}"
                />
              </view>
            </view>
            
            <!-- 数量操作 -->
            <view class="quantity-row">
              <text class="quantity-label">数量</text>
              <view class="quantity-controls">
                <text class="quantity-btn minus" bindtap="decreaseQuantity" data-index="{{index}}">-</text>
                <input 
                  class="quantity-input" 
                  type="digit" 
                  value="{{item.quantity}}" 
                  bindinput="onQuantityChange" 
                  data-index="{{index}}"
                />
                <text class="quantity-btn plus" bindtap="increaseQuantity" data-index="{{index}}">+</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 总金额 -->
    <view class="form-item" wx:if="{{selectedProducts.length > 0}}">
      <text class="form-label">总金额</text>
      <view class="total-amount red-amount">
        <text class="amount-value">¥{{totalAmount}}</text>
      </view>
    </view>

    <!-- 备注 -->
    <view class="form-item">
      <text class="form-label">备注</text>
      <textarea 
        class="form-textarea" 
        placeholder="请输入备注信息" 
        value="{{remark}}" 
        bindinput="onRemarkChange"
      ></textarea>
    </view>

    <button class="submit-btn" bindtap="submit" disabled="{{submitLoading}}">
      {{submitLoading ? '提交中...' : '生成销售单'}}
    </button>
  </view>
</view>